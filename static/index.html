<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EduSimplify ‚Äì CEFR-Aware French Text Simplifier</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-main: #f5f5fb;
      --bg-card: #ffffff;
      --bg-original: #fdf7f1;
      --bg-simplified: #f3f9ff;
      --accent: #4b6fff;
      --accent-soft: #e0e7ff;
      --border-soft: #e0e0eb;
      --text-main: #222222;
      --text-soft: #555555;
      --danger: #e54b4b;
      --font-sans: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: var(--font-sans);
      background: radial-gradient(circle at top left, #f6f0ff 0, #f5f5fb 40%, #f0f4ff 100%);
      color: var(--text-main);
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      gap: 12px;
    }

    .logo-area {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-area img {
      width: 56px;
      height: 56px;
      object-fit: contain;
    }

    .title-block h1 {
      margin: 0;
      font-size: 1.8rem;
      letter-spacing: 0.03em;
    }

    .title-block p {
      margin: 2px 0 0;
      font-size: 0.9rem;
      color: var(--text-soft);
    }

    .tagline {
      font-size: 0.85rem;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(75, 111, 255, 0.08);
      color: #2f3f8f;
      border: 1px solid rgba(75, 111, 255, 0.17);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .tagline span {
      font-size: 1rem;
    }

    .card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 18px 18px 20px;
      box-shadow:
        0 18px 45px rgba(15, 23, 42, 0.04),
        0 1px 0 rgba(15, 23, 42, 0.04);
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    .card + .card {
      margin-top: 16px;
    }

    h2 {
      font-size: 1.1rem;
      margin-top: 0;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    h2 span.icon {
      font-size: 1.2rem;
    }

    h3 {
      font-size: 0.95rem;
      margin: 12px 0 8px;
    }

    p {
      margin: 6px 0;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .small {
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    textarea {
      width: 100%;
      min-height: 130px;
      resize: vertical;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      font-family: inherit;
      font-size: 0.95rem;
      line-height: 1.6;
      background: #fff;
    }

    textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(75, 111, 255, 0.3);
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 10px;
      align-items: center;
    }

    .controls-row > div {
      background: #f8f9ff;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
    }

    .controls-row label {
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .controls-row input[type="radio"] {
      margin-right: 4px;
    }

    .controls-row select {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 4px 6px;
      font-size: 0.8rem;
      background: #ffffff;
      min-width: 80px;
    }

    .primary-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 14px;
      justify-content: space-between;
      align-items: center;
    }

    .primary-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }

    #simplify-btn {
      background: linear-gradient(135deg, #4b6fff, #7b5cff);
      color: #fff;
      box-shadow: 0 10px 22px rgba(75, 111, 255, 0.35);
    }

    #simplify-btn:disabled {
      opacity: 0.7;
      cursor: wait;
      box-shadow: none;
    }

    .secondary-btn {
      background: #f2f4ff;
      color: #24308f;
      border: 1px solid rgba(148, 163, 184, 0.6);
    }

    .danger-btn {
      background: #fff2f2;
      color: #b91c1c;
      border: 1px solid rgba(239, 68, 68, 0.5);
    }

    .layout-two {
      margin-top: 18px;
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 14px;
    }

    .panel {
      border-radius: 14px;
      padding: 12px 12px 12px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: var(--bg-card);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .panel.original {
      background: var(--bg-original);
    }

    .panel.simplified {
      background: var(--bg-simplified);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }

    .panel-header h3 {
      margin: 0;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .badge {
      font-size: 0.7rem;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.04);
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: #4b5563;
    }

    .meta-line {
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .meta-line strong {
      font-weight: 600;
    }

    .text-box {
      margin-top: 6px;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.75);
      min-height: 80px;
      font-size: 0.9rem;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .diagnostic {
      margin-top: 4px;
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .diagnostic-list {
      padding-left: 18px;
      margin: 4px 0 0;
    }

    .diagnostic-list li {
      margin: 2px 0;
    }

    .word-hard {
      background: rgba(248, 113, 113, 0.15);
      border-bottom: 1px dotted rgba(220, 38, 38, 0.8);
      padding: 1px 0;
    }

    .word-medium {
      background: rgba(251, 191, 36, 0.15);
      border-bottom: 1px dotted rgba(202, 138, 4, 0.9);
      padding: 1px 0;
    }

    .word-easy {
      background: rgba(34, 197, 94, 0.08);
      border-bottom: 1px dotted rgba(22, 163, 74, 0.7);
      padding: 1px 0;
    }

    .cefr-row {
      margin-top: 14px;
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
      gap: 12px;
      align-items: stretch;
    }

    .cefr-card {
      border-radius: 14px;
      padding: 10px 12px 12px;
      background: #eef2ff;             /* softer background */
      color: #111827;
      box-shadow:
        0 6px 16px rgba(15, 23, 42, 0.08);
      border: 1px solid rgba(129, 140, 248, 0.7);
    }

    .cefr-card h3 {
      margin: 0 0 4px;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .cefr-card p {
      margin: 4px 0;
      font-size: 0.8rem;
      color: #1f2933;
    }

    .cefr-card p strong {
      color: #111827;
    }

    .strategy-card {
      border-radius: 14px;
      padding: 10px 12px;
      border: 1px dashed rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.02);
      font-size: 0.8rem;
    }

    .tts-row {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      font-size: 0.8rem;
    }

    .tts-row select {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 3px 7px;
      font-size: 0.8rem;
      background: #ffffff;
    }

    #tts-play-btn {
      padding: 6px 10px;
      font-size: 0.8rem;
    }

    @media (max-width: 860px) {
      .layout-two {
        grid-template-columns: minmax(0, 1fr);
      }
      .cefr-row {
        grid-template-columns: minmax(0, 1fr);
      }
      header {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    @media (max-width: 600px) {
      .card {
        padding: 14px;
      }
      .panel {
        padding: 10px;
      }
      .page {
        padding-inline: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="logo-area">
    <img src="logo.png" alt="EduSimplify logo" />
    <div class="title-block">
      <h1>EduSimplify</h1>
      <p>CEFR-aware French text simplification for learners and teachers.</p>
    </div>
  </div>  
      <div class="tagline">
        <span>üìö</span>
        <span>Making classical French readable from A1 to C1</span>
      </div>
    </header>

    <section class="card">
      <h2>
        <span class="icon">‚úèÔ∏è</span>
        Paste a French text to simplify
      </h2>
      <p class="small">
        Paste any French sentence or paragraph (classical or modern). EduSimplify analyses difficulty,
        estimates a CEFR level, and generates a simplified version based on your settings.
      </p>

      <textarea id="input-text" placeholder="Example: Nonobstant les vives critiques formul√©es par l'opposition, le gouvernement a maintenu son cap, arguant que ces r√©formes √©taient imp√©ratives."></textarea>

      <div class="controls-row">
        <div>
          <strong>Mode:</strong>
          <label><input type="radio" name="mode" value="light"> Light</label>
          <label><input type="radio" name="mode" value="standard" checked> Standard</label>
          <label><input type="radio" name="mode" value="strong"> Strong</label>
        </div>

        <div>
          <strong>Strategy:</strong>
          <label><input type="radio" name="strategy" value="auto" checked> Auto</label>
          <label><input type="radio" name="strategy" value="target"> Target level</label>
          <select id="target-level" disabled>
            <option value="">CEFR level‚Ä¶</option>
            <option value="A1">A1</option>
            <option value="A2">A2</option>
            <option value="B1">B1</option>
            <option value="B2">B2</option>
            <option value="C1">C1</option>
          </select>
        </div>
      </div>

      <div class="primary-row">
        <div class="primary-actions">
          <button id="simplify-btn">‚öôÔ∏è Simplify and analyse</button>
          <button id="copy-original-btn" class="secondary-btn">üìã Copy original</button>
          <button id="copy-simplified-btn" class="secondary-btn">üìã Copy simplified</button>
        </div>
        <div class="primary-actions">
          <button id="export-txt-btn" class="secondary-btn">üìù Export .txt</button>
          <button id="export-report-btn" class="secondary-btn">üìÑ Export report (.txt)</button>
          <button id="export-pdf-btn" class="secondary-btn">üñ®Ô∏è PDF preview</button>
        </div>
      </div>

      <div class="tts-row">
        <span>üîä Read aloud:</span>
        <label for="tts-target">Text</label>
        <select id="tts-target">
          <option value="original">Original</option>
          <option value="simplified">Simplified</option>
        </select>

        <label for="tts-voice">Voice</label>
        <select id="tts-voice">
          <option value="female">Female</option>
          <option value="male">Male</option>
        </select>

        <label for="tts-speed">Speed</label>
        <select id="tts-speed">
          <option value="slow">Slow</option>
          <option value="normal" selected>Normal</option>
          <option value="fast">Fast</option>
        </select>

        <!-- Speaker icon button -->
        <button id="tts-play-btn" class="secondary-btn">üîà Play</button>
      </div>
    </section>

    <section class="layout-two">
      <div class="panel original">
        <div class="panel-header">
          <h3>Original text</h3>
          <span id="original-meta" class="meta-line">Level: ‚Äî ¬∑ Sentences: ‚Äî ¬∑ Words: ‚Äî</span>
        </div>
        <p id="original-band" class="small"></p>
        <p id="original-explanation" class="small"></p>
        <div id="original-text-box" class="text-box">
          The original text will appear here, with rare words highlighted.
        </div>
        <div id="original-diagnostic" class="diagnostic"></div>
      </div>

      <div class="panel simplified">
        <div class="panel-header">
          <h3>Simplified text</h3>
          <span id="simplified-meta" class="meta-line">Level: ‚Äî ¬∑ Sentences: ‚Äî ¬∑ Words: ‚Äî</span>
        </div>
        <p id="simplified-band" class="small"></p>
        <p id="simplified-explanation" class="small"></p>
        <div id="simplified-text-box" class="text-box">
          The simplified version will appear here.
        </div>
      </div>
    </section>

    <section class="cefr-row">
      <div class="cefr-card">
        <h3>üéì CEFR ‚Äì Detected level</h3>
        <p id="cefr-level-line"><strong>Detected level:</strong> ‚Äî</p>
        <p id="cefr-description">
          The system estimates a CEFR level (A1 to C1) and shows a short pedagogical description here.
        </p>
        <p id="cefr-strategy" class="small"></p>
      </div>

      <div class="strategy-card">
        <strong>üß† Simplification strategy</strong>
        <p id="strategy-explanation" class="small" style="margin-top: 4px;">
          Choose a mode and a strategy, then run simplification. The details of how the text was transformed will appear here.
        </p>
        <p class="small">
          No text is stored. Everything is processed locally via the FastAPI backend.
        </p>
      </div>
    </section>
  </div>

  <script>
    const simplifyBtn = document.getElementById("simplify-btn");
    const inputText = document.getElementById("input-text");
    const targetLevelSelect = document.getElementById("target-level");

    const copyOriginalBtn = document.getElementById("copy-original-btn");
    const copySimplifiedBtn = document.getElementById("copy-simplified-btn");
    const exportTxtBtn = document.getElementById("export-txt-btn");
    const exportReportBtn = document.getElementById("export-report-btn");
    const exportPdfBtn = document.getElementById("export-pdf-btn");

    const ttsPlayBtn = document.getElementById("tts-play-btn");
    const ttsTargetSelect = document.getElementById("tts-target");
    const ttsVoiceSelect = document.getElementById("tts-voice");
    const ttsSpeedSelect = document.getElementById("tts-speed");

    const CEFR_LEVEL_INFO = {
      "A1": {
        label: "A1 ‚Äì Beginner user",
        description: "Very simple sentences, basic vocabulary, communication possible in familiar concrete situations."
      },
      "A2": {
        label: "A2 ‚Äì Elementary user",
        description: "Can understand and produce short sentences about everyday needs (family, shopping, simple work)."
      },
      "B1": {
        label: "B1 ‚Äì Independent user",
        description: "Can understand main points of clear speech and describe events with some fluency."
      },
      "B2": {
        label: "B2 ‚Äì Upper independent user",
        description: "Understands more complex texts and can argue with good fluency on a wide range of topics."
      },
      "C1": {
        label: "C1 ‚Äì Proficient user",
        description: "Understands long, demanding texts and uses the language flexibly with nuance."
      }
    };

    function updateCefrBox(level, strategyExplanation) {
      const levelLine = document.getElementById("cefr-level-line");
      const descriptionEl = document.getElementById("cefr-description");
      const strategyEl = document.getElementById("cefr-strategy");

      if (!level) {
        levelLine.innerHTML = "<strong>Detected level:</strong> ‚Äî";
        descriptionEl.textContent = "The CEFR level could not be determined for this text.";
        strategyEl.textContent = strategyExplanation || "";
        return;
      }

      const info = CEFR_LEVEL_INFO[level] || null;

      if (info) {
        levelLine.innerHTML = "<strong>Detected level:</strong> " + info.label;
        descriptionEl.textContent = info.description;
      } else {
        levelLine.innerHTML = "<strong>Detected level:</strong> " + level;
        descriptionEl.textContent = "CEFR level not recognised in the internal table.";
      }

      strategyEl.textContent = strategyExplanation || "";
    }

    document.querySelectorAll('input[name="strategy"]').forEach(radio => {
      radio.addEventListener("change", () => {
        if (radio.value === "target" && radio.checked) {
          targetLevelSelect.disabled = false;
        } else if (radio.value === "auto" && radio.checked) {
          targetLevelSelect.disabled = true;
          targetLevelSelect.value = "";
        }
      });
    });

    function getSelectedMode() {
      const checked = document.querySelector('input[name="mode"]:checked');
      return checked ? checked.value : "standard";
    }

    function getSelectedStrategy() {
      const checked = document.querySelector('input[name="strategy"]:checked');
      return checked ? checked.value : "auto";
    }

    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function escapeRegExp(str) {
      return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }

    function highlightText(text, wordDifficulty) {
      let out = escapeHtml(text);

      if (!Array.isArray(wordDifficulty) || wordDifficulty.length === 0) {
        return out;
      }

      const sorted = [...wordDifficulty].sort((a, b) => {
        const order = { hard: 0, medium: 1, easy: 2 };
        const da = order[a.difficulty] ?? 1;
        const db = order[b.difficulty] ?? 1;
        if (da !== db) return da - db;
        return (b.form || "").length - (a.form || "").length;
      });

      for (const w of sorted) {
        if (!w.form || !w.difficulty) continue;

        let cls = "";
        if (w.difficulty === "hard") cls = "word-hard";
        else if (w.difficulty === "medium") cls = "word-medium";
        else if (w.difficulty === "easy") cls = "word-easy";
        else continue;

        const pattern = new RegExp("\\b" + escapeRegExp(w.form) + "\\b", "gi");
        out = out.replace(
          pattern,
          (match) => `<span class="${cls}">${match}</span>`
        );
      }

      return out;
    }

    function renderAnalysis(
      analysis,
      metaEl,
      bandEl,
      explanationEl,
      diagnosticEl,
      textBoxEl,
      originalText
    ) {
      if (!analysis) {
        metaEl.textContent = "No analysis available.";
        if (bandEl) bandEl.textContent = "";
        if (explanationEl) explanationEl.textContent = "";
        if (diagnosticEl) diagnosticEl.innerHTML = "";
        if (textBoxEl) textBoxEl.textContent = originalText || "";
        return;
      }

      const level = analysis.estimated_level || "-";
      const sentences = analysis.sentences ?? 0;
      const tokens = analysis.tokens ?? 0;
      const avgLen = analysis.avg_sentence_length?.toFixed
        ? analysis.avg_sentence_length.toFixed(1)
        : analysis.avg_sentence_length;

      metaEl.textContent = `Level: ${level} ¬∑ Sentences: ${sentences} ¬∑ Words: ${tokens} ¬∑ Avg. length: ${avgLen}`;

      if (bandEl) {
        const band = analysis.level_band || [];
        const bandText = Array.isArray(band) && band.length === 2
          ? `${band[0]} ‚Äì ${band[1]}`
          : "";
        const bandExpl = analysis.level_band_explanation || "";
        bandEl.textContent = bandText ? `Level band: ${bandText}` : "";
        if (explanationEl) explanationEl.textContent = bandExpl;
      } else if (explanationEl) {
        explanationEl.textContent = analysis.explanation || "";
      }

      if (diagnosticEl) {
        const wordDiff = analysis.word_difficulty || [];
        const hardWords = wordDiff.filter(w => w.difficulty === "hard");
        if (hardWords.length === 0) {
          diagnosticEl.innerHTML = "<p>No rare words detected. The vocabulary is globally frequent.</p>";
        } else {
          const items = hardWords
            .slice(0, 12)
            .map(w => {
              const countLabel = w.count > 1 ? `${w.count} occurrences` : "1 occurrence";
              const zipf = (w.zipf ?? 0).toFixed(2);
              return `<li><strong>${escapeHtml(w.form)}</strong> ¬∑ Zipf ${zipf} ¬∑ ${countLabel}</li>`;
            })
            .join("");
          diagnosticEl.innerHTML = `
            <p><strong>Rare words detected (${hardWords.length}):</strong></p>
            <ul class="diagnostic-list">${items}</ul>
          `;
        }
      }

      if (textBoxEl) {
        const wordDiff = analysis.word_difficulty || [];
        const highlighted = highlightText(originalText || "", wordDiff);
        textBoxEl.innerHTML = highlighted;
      }
    }

    function copyToClipboard(text, label) {
      if (!navigator.clipboard) {
        alert("Copy is not available in this browser.");
        return;
      }
      navigator.clipboard.writeText(text || "").then(
        () => {
          if (label) {
            alert(label + " has been copied to the clipboard.");
          }
        },
        () => {
          alert("Unable to copy text.");
        }
      );
    }

    function downloadTxt(filename, content) {
      const blob = new Blob([content || ""], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function exportPdfLike(original, simplified) {
      const html = `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EduSimplify ‚Äì Export</title>
  <style>
    body { font-family: -apple-system, system-ui, sans-serif; padding: 24px; color: #111827; }
    h1 { font-size: 1.4rem; margin-bottom: 0.5rem; }
    h2 { font-size: 1.1rem; margin-top: 1.4rem; }
    pre { background: #f9fafb; padding: 12px; border-radius: 8px; white-space: pre-wrap; }
    .meta { font-size: 0.85rem; color: #4b5563; margin-bottom: 1rem; }
    button { margin-top: 1rem; padding: 6px 10px; }
  </style>
</head>
<body>
  <h1>EduSimplify ‚Äì Export</h1>
  <div class="meta">Document generated from the EduSimplify interface.</div>
  <h2>Original text</h2>
  <pre>${escapeHtml(original || "(empty)")}</pre>
  <h2>Simplified text</h2>
  <pre>${escapeHtml(simplified || "(empty)")}</pre>
  <button onclick="window.print()">üñ®Ô∏è Print / Save as PDF</button>
</body>
</html>`;
      const win = window.open("", "_blank");
      if (!win) {
        alert("Please allow pop-ups in your browser to use PDF preview.");
        return;
      }
      win.document.open();
      win.document.write(html);
      win.document.close();
    }

    let ttsVoices = [];

    function loadVoices() {
      ttsVoices = window.speechSynthesis.getVoices();
    }

    if ("speechSynthesis" in window) {
      loadVoices();
      window.speechSynthesis.onvoiceschanged = loadVoices;
    }

    function pickVoice(gender) {
      if (!ttsVoices || ttsVoices.length === 0) return null;
      const frVoices = ttsVoices.filter(v => v.lang && v.lang.toLowerCase().startsWith("fr"));
      if (frVoices.length === 0) return ttsVoices[0];

      const pattern = gender === "female"
        ? /female|femme|woman|frau|madame/i
        : /male|homme|man|herr|monsieur/i;

      const match = frVoices.find(v => pattern.test(v.name));
      return match || frVoices[0];
    }

    ttsPlayBtn.addEventListener("click", () => {
      if (!("speechSynthesis" in window)) {
        alert("Text-to-speech is not available in this browser.");
        return;
      }

      const target = ttsTargetSelect.value || "original";
      const voicePref = ttsVoiceSelect.value || "female";
      const speed = ttsSpeedSelect.value || "normal";

      const originalText = document.getElementById("original-text-box").innerText || "";
      const simplifiedText = document.getElementById("simplified-text-box").innerText || "";

      const text = target === "simplified" ? simplifiedText : originalText;

      if (!text.trim()) {
        alert("There is no text to read in the selected area.");
        return;
      }

      window.speechSynthesis.cancel();

      const utter = new SpeechSynthesisUtterance(text);
      const voice = pickVoice(voicePref);
      if (voice) utter.voice = voice;

      if (speed === "slow") utter.rate = 0.8;
      else if (speed === "fast") utter.rate = 1.25;
      else utter.rate = 1.0;

      utter.lang = (voice && voice.lang) || "fr-FR";
      window.speechSynthesis.speak(utter);
    });

    simplifyBtn.addEventListener("click", async () => {
      const text = inputText.value.trim();
      if (!text) {
        alert("Please enter a French text to simplify.");
        return;
      }

      const mode = getSelectedMode();
      const strategy = getSelectedStrategy();
      const target = targetLevelSelect.disabled ? null : (targetLevelSelect.value || null);

      const payload = {
        text: text,
        mode: mode,
        strategy: strategy,
        target: target,
      };

      simplifyBtn.disabled = true;
      simplifyBtn.textContent = "‚è≥ Processing‚Ä¶";

      try {
        const response = await fetch("/simplify", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          throw new Error("Network or server error.");
        }

        const data = await response.json();

        const original = data.original || text;
        const simplified = data.simplified || "";

        const analysisOriginal = data.analysis_original || data.analysisOriginal || null;
        const analysisSimplified = data.analysis_simplified || data.analysisSimplified || null;
        const targetLevel = data.target_level || data.targetLevel || null;
        const stratExp = data.strategy_explanation || data.strategyExplanation || "";
        const strategyUsed = data.strategy || strategy;

        renderAnalysis(
          analysisOriginal,
          document.getElementById("original-meta"),
          document.getElementById("original-band"),
          document.getElementById("original-explanation"),
          document.getElementById("original-diagnostic"),
          document.getElementById("original-text-box"),
          original
        );

        const simplifiedMetaEl = document.getElementById("simplified-meta");
        const simplifiedBandEl = document.getElementById("simplified-band");
        const simplifiedExplEl = document.getElementById("simplified-explanation");
        const simplifiedBoxEl = document.getElementById("simplified-text-box");

        if (analysisSimplified) {
          const level = analysisSimplified.estimated_level || "-";
          const sents = analysisSimplified.sentences ?? 0;
          const toks = analysisSimplified.tokens ?? 0;
          const avgLen = analysisSimplified.avg_sentence_length?.toFixed
            ? analysisSimplified.avg_sentence_length.toFixed(1)
            : analysisSimplified.avg_sentence_length;

          simplifiedMetaEl.textContent = `Level: ${level} ¬∑ Sentences: ${sents} ¬∑ Words: ${toks} ¬∑ Avg. length: ${avgLen}`;

          const band = analysisSimplified.level_band || [];
          const bandText = Array.isArray(band) && band.length === 2
            ? `${band[0]} ‚Äì ${band[1]}`
            : "";
          const bandExpl = analysisSimplified.level_band_explanation || "";
          simplifiedBandEl.textContent = bandText ? `Level band: ${bandText}` : "";
          simplifiedExplEl.textContent = bandExpl;
        } else {
          simplifiedMetaEl.textContent = "No analysis available for the simplified text.";
          simplifiedBandEl.textContent = "";
          simplifiedExplEl.textContent = "";
        }

        simplifiedBoxEl.textContent = simplified || "The simplified version is empty.";

        const strategyEl = document.getElementById("strategy-explanation");
        let extraLine = "";
        if (targetLevel) {
          extraLine = `Strategy: ${strategyUsed === "target" ? "target level" : "auto"} ¬∑ Target level: ${targetLevel}`;
        } else {
          extraLine = `Strategy: ${strategyUsed === "target" ? "target level" : "auto"}`;
        }

        strategyEl.innerHTML = `
          <p>${escapeHtml(stratExp || "")}</p>
          <p class="mono">${escapeHtml(extraLine)}</p>
        `;

        updateCefrBox(
          (analysisSimplified && analysisSimplified.estimated_level) ||
          (analysisOriginal && analysisOriginal.estimated_level) ||
          targetLevel,
          stratExp
        );

        copyOriginalBtn.onclick = () => copyToClipboard(original, "Original text");
        copySimplifiedBtn.onclick = () => copyToClipboard(simplified, "Simplified text");

        exportTxtBtn.onclick = () => {
          if (!simplified) {
            alert("There is no simplified text to export.");
            return;
          }
          downloadTxt("edusimplify_simplified.txt", simplified);
        };

        exportReportBtn.onclick = () => {
          const content = "=== ORIGINAL TEXT ===\n\n" + (original || "(empty)") +
            "\n\n=== SIMPLIFIED TEXT ===\n\n" + (simplified || "(empty)") + "\n";
          downloadTxt("edusimplify_report.txt", content);
        };

        exportPdfBtn.onclick = () => {
          exportPdfLike(original, simplified);
        };

      } catch (err) {
        console.error(err);
        alert("An error occurred during simplification.");
      } finally {
        simplifyBtn.disabled = false;
        simplifyBtn.textContent = "‚öôÔ∏è Simplify and analyse";
      }
    });
  </script>
</body>
</html>